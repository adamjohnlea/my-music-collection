{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
  <style>
    :root { --bg:#0b0b0c; --card:#16171a; --text:#e7e7ea; --muted:#a0a3aa; --accent:#67e8f9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    .wrap{max-width:1200px;margin:40px auto;padding:0 20px}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(11,11,12,.7);margin:-16px -20px 24px -20px;padding:16px 20px}
    .header-top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .header-bottom{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{font-size:1.4rem;margin:0}
    .stats{font-size:.9rem}
    .nav-group{display:flex;align-items:center;gap:16px}
    .view-tabs{display:flex;gap:4px;background:#1a1b1f;padding:4px;border-radius:10px}
    .view-tab{padding:6px 14px;border-radius:8px;font-size:.95rem;font-weight:500;color:var(--muted);text-decoration:none}
    .view-tab:hover{color:var(--text)}
    .view-tab.active{background:var(--card);color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden}
    .cover{aspect-ratio:1/1;width:100%;object-fit:cover;background:linear-gradient(90deg,#1a1b1f 25%,#22242a 37%,#1a1b1f 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    .cover.ready{animation:none;background:#222}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .meta{padding:10px}
    .title{font-weight:600}
    .artist{color:var(--muted);font-size:.9rem}
    .muted{color:var(--muted)}
    .action-btns{display:flex;gap:4px;margin-top:8px}
    .btn-small{font-size:.8rem;padding:4px 8px;border:1px solid #2a2b2f;border-radius:6px;background:var(--card);color:var(--text);cursor:pointer;text-decoration:none}
    .btn-small:hover:not(:disabled){border-color:var(--accent)}
    .btn-small:disabled{opacity:.5;cursor:not-allowed}
    nav{display:flex;justify-content:center;gap:12px;margin-top:20px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    /* Toolbar */
    .toolbar{display:flex;gap:8px;align-items:center;margin:0;flex-wrap:wrap}
    .search-input{background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:10px;padding:8px 14px;width:400px;max-width:100%;font-size:.95rem}
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px rgba(103,232,249,.2)}
    .sort-wrap{display:flex;gap:8px;align-items:center}
    .sort-select{background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:10px;padding:8px 12px;font-size:.9rem;cursor:pointer}
    .sort-select:focus{outline:none;border-color:var(--accent)}
    /* Modern pagination */
    .pagination{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}
    .page-btn{display:inline-flex;align-items:center;justify-content:center;min-width:40px;height:40px;padding:0 12px;border-radius:12px;border:1px solid #2a2b2f;background:var(--card);color:var(--text);text-decoration:none;font-weight:600}
    .page-btn:hover{background:#1d1f24;text-decoration:none}
    .page-btn.is-current{background:linear-gradient(135deg,#222631,#1a1d24);border-color:#3a3d44;box-shadow:0 0 0 1px rgba(103,232,249,.2) inset;color:#fff}
    .page-btn.is-disabled{opacity:.5;pointer-events:none}
    .page-ellipsis{color:var(--muted);padding:0 6px}

    /* Sidebar and Layout */
    .main-layout{display:grid;grid-template-columns:240px 1fr;gap:32px;align-items:start}
    .sidebar{position:sticky;top:100px;display:flex;flex-direction:column;gap:24px}
    .sidebar-section h3{font-size:.85rem;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin:0 0 12px 0}
    .sidebar-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px}
    .sidebar-link{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:8px;font-size:.95rem;color:var(--text);text-decoration:none;transition:background .2s}
    .sidebar-link:hover{background:rgba(255,255,255,.05);text-decoration:none}
    .sidebar-link.active{background:rgba(103,232,249,.1);color:var(--accent)}
    .sidebar-link .delete-btn{opacity:0;background:transparent;border:none;color:var(--muted);cursor:pointer;padding:4px;line-height:1}
    .sidebar-link:hover .delete-btn{opacity:1}
    .sidebar-link .delete-btn:hover{color:#ff4444}

    /* Small screens */
    @media (max-width: 640px){
      .main-layout{grid-template-columns:1fr}
      .sidebar{position:static;margin-bottom:24px}
      .wrap{margin:20px auto}
      header{gap:12px}
      .header-top{flex-direction:column;align-items:flex-start}
      .header-bottom{flex-direction:column;align-items:stretch}
      .nav-group{width:100%;justify-content:space-between}
      .view-tabs{width:100%}
      .view-tab{flex:1;text-align:center}
      .muted.stats{width:100%;margin-top:4px}
      .toolbar{width:100%;flex-direction:column;align-items:stretch}
      .search-input{width:100%}
      .sort-wrap{width:100%}
      .sort-select{width:100%}
      .about-link{order:3;margin-left:0}
      /* Make pagination sticky at the bottom with safe-area */
      .pagination{position:sticky;bottom:calc(8px + env(safe-area-inset-bottom));background:rgba(11,11,12,.8);backdrop-filter:blur(8px);padding:8px 12px;border-radius:14px;border:1px solid #2a2b2f}
      .page-num,.page-ellipsis{display:none}
      .page-btn{min-width:64px;height:44px;font-size:1rem}
    }
  </style>
{% endblock %}

{% block header %}
  <div class="wrap">
    <header>
      <div class="header-top">
        <h1><a href="/" style="color:inherit;text-decoration:none">{{ title }}</a></h1>
        <div class="nav-group">
          {% if auth_user %}
            <div style="display:flex;gap:12px;align-items:center">
              <a href="/random" class="muted" title="Surprise Me">Surprise Me</a>
              <a href="/stats" class="muted" title="Stats">Stats</a>
              <a href="/about" class="muted about-link" title="About">About</a>
              <div style="width:1px;height:16px;background:#2a2b2f;margin:0 4px"></div>
              <span class="muted" style="font-size:.9rem">{{ auth_user.username }}</span>
              <a href="/settings" class="muted" title="Account settings">Settings</a>
              <form method="post" action="/logout" style="margin:0">
                <input type="hidden" name="_token" value="{{ csrf_token }}">
                <button type="submit" class="muted" style="background:transparent;border:1px solid #2a2b2f;border-radius:8px;padding:4px 10px;cursor:pointer;color:inherit;font-size:.85rem">Sign out</button>
              </form>
            </div>
          {% else %}
            <a href="/about" class="muted">About</a>
            <a href="/login" class="muted">Sign in</a>
          {% endif %}
        </div>
      </div>

      {% if auth_user and not welcome and not needs_setup %}
        <div class="header-bottom">
          <div class="nav-group">
            <nav class="view-tabs">
              <a href="/?view=collection" class="view-tab {{ view=='collection' or view is not defined ? 'active' : '' }}">Collection</a>
              <a href="/?view=wantlist" class="view-tab {{ view=='wantlist' ? 'active' : '' }}">Wantlist</a>
            </nav>
            <div class="muted stats" style="padding-top:20px">{{ total|default(0) }} items{% if q is defined and q %} ‚Ä¢ Search: ‚Äú{{ q }}‚Äù{% endif %}</div>
          </div>

          <form id="search-form" class="toolbar" method="get" action="/">
            <input id="search-input" class="search-input" type="text" name="q" value="{{ q|default('')|e }}" placeholder="Search artist:miles year:1980..1989 barcode:‚Ä¶" />
            <input type="hidden" name="view" value="{{ view|default('collection') }}" />
            <input type="hidden" name="per_page" value="{{ per_page }}" />
            {% if q is defined and q %}
              <button type="button" class="btn-small" onclick="saveSearch()" title="Save as Smart Collection">Save</button>
            {% endif %}
            <span class="sort-wrap">
              <select id="sort" class="sort-select" name="sort" onchange="this.form.submit()">
                <optgroup label="Sort by">
                  <option value="added_desc" {{ sort=='added_desc'?'selected':'' }}>Added (newest)</option>
                  <option value="added_asc" {{ sort=='added_asc'?'selected':'' }}>Added (oldest)</option>
                  {% if view != 'wantlist' %}
                    <option value="rating_desc" {{ sort=='rating_desc'?'selected':'' }}>Rating (high‚Üílow)</option>
                    <option value="rating_asc" {{ sort=='rating_asc'?'selected':'' }}>Rating (low‚Üíhigh)</option>
                  {% endif %}
                  <option value="year_desc" {{ sort=='year_desc'?'selected':'' }}>Year (newest)</option>
                  <option value="year_asc" {{ sort=='year_asc'?'selected':'' }}>Year (oldest)</option>
                  <option value="artist_asc" {{ sort=='artist_asc'?'selected':'' }}>Artist (A‚ÜíZ)</option>
                  <option value="artist_desc" {{ sort=='artist_desc'?'selected':'' }}>Artist (Z‚ÜíA)</option>
                  <option value="title_asc" {{ sort=='title_asc'?'selected':'' }}>Title (A‚ÜíZ)</option>
                  <option value="title_desc" {{ sort=='title_desc'?'selected':'' }}>Title (Z‚ÜíA)</option>
                </optgroup>
              </select>
            </span>
          </form>
        </div>

        {% if chips is defined and chips %}
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;width:100%">
            {% for c in chips %}
              <span class="muted" style="border:1px solid #2a2b2f;border-radius:999px;padding:2px 10px;font-size:.85rem">{{ c.label }}</span>
            {% endfor %}
            <a href="/?view={{ view }}&per_page={{ per_page }}&sort={{ sort }}" class="muted" style="margin-left:4px;font-size:.85rem">Clear</a>
          </div>
        {% endif %}
      {% endif %}
    </header>
  </div>
{% endblock %}

{% block content %}
  <div class="wrap">
    <div class="main-layout">
      <aside class="sidebar">
        <div class="sidebar-section">
          <h3>Smart Collections</h3>
          <ul class="sidebar-list">
            <li>
              <a href="/" class="sidebar-link {{ q == '' ? 'active' : '' }}">
                <span>All Items</span>
              </a>
            </li>
            {% if saved_searches is defined %}
              {% for s in saved_searches %}
                <li>
                  <a href="/?q={{ s.query|url_encode }}" class="sidebar-link {{ q == s.query ? 'active' : '' }}">
                    <span>{{ s.name }}</span>
                    <form method="post" action="/saved-searches/delete" style="display:inline">
                      <input type="hidden" name="_token" value="{{ csrf_token }}">
                      <input type="hidden" name="id" value="{{ s.id }}">
                      <button type="submit" class="delete-btn" title="Delete collection" onclick="return confirm('Delete this smart collection?')">√ó</button>
                    </form>
                  </a>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
      </aside>

      <div class="main-content">
        {% if welcome %}
          <div class="card"><div class="meta">
            <h2 style="margin:0 0 8px 0">Welcome</h2>
            <p class="muted">Browse your Discogs collection locally, fast. Create an account to get started.</p>
            <p><a href="/register">Create an account</a> or <a href="/login">Sign in</a>. Learn more on the <a href="/about">About</a> page.</p>
          </div></div>
        {% elseif needs_setup %}
          <div class="card"><div class="meta">
            <h2 style="margin:0 0 8px 0">Connect your Discogs account</h2>
            <p class="muted">To show your collection here, add your Discogs username and user token on the Settings page, then run the initial sync from the terminal.</p>
            <ol style="margin:0 0 0 20px;padding:0">
              <li>Go to <a href="/settings">Settings</a> and enter your Discogs username and user token.</li>
              <li>From your project folder, run: <code>php bin/console sync:initial</code></li>
              <li>Come back here to browse your collection.</li>
            </ol>
          </div></div>
        {% elseif items is not defined or items|length == 0 %}
          <p class="muted">No items to display. If you already ran the sync, try refreshing. Otherwise run: <code>php bin/console sync:initial</code>.</p>
        {% else %}
          {% set return_to = '/?view=' ~ (view|default('collection')) ~ '&per_page=' ~ per_page ~ '&sort=' ~ sort ~ '&page=' ~ page ~ (q is defined and q ? '&q=' ~ (q|url_encode) : '') %}
          <div class="grid">
            {% for it in items %}
              <div class="card" title="{{ it.title }} ‚Äî {{ it.artist|strip_discogs_suffix }}">
                {% if it.image %}
                  <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">
                    <img class="cover" src="{{ it.image }}" alt="{{ it.title }} cover" loading="lazy" />
                  </a>
                {% else %}
                  <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">
                    <div class="cover"></div>
                  </a>
                {% endif %}
                <div class="meta">
                  <div class="title">
                    {% if it.is_discogs_result %}
                      <span title="Discogs Result" style="cursor:help">üåê</span>
                    {% endif %}
                    <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">{{ it.title }}</a>
                  </div>
                  <div class="artist">
                    {% if it.is_discogs_result %}
                      {# artist name is often included in title for discogs search results #}
                    {% else %}
                      <a href="/?view={{ view|default('collection') }}&per_page={{ per_page }}&sort={{ sort }}&q={{ ('artist:\"' ~ it.artist ~ '\"')|url_encode }}">{{ it.artist|strip_discogs_suffix }}</a>
                    {% endif %}
                    {% if it.year %}
                      {% if not it.is_discogs_result %} ‚Ä¢ {% endif %}
                      <a href="/?view={{ view|default('collection') }}&per_page={{ per_page }}&sort={{ sort }}&q={{ ('year:' ~ it.year)|url_encode }}">{{ it.year }}</a>
                    {% endif %}
                  </div>
                  
                  {% if it.is_discogs_result %}
                    <div class="action-btns">
                      <form method="post" action="/release/add">
                        <input type="hidden" name="_token" value="{{ csrf_token }}">
                        <input type="hidden" name="release_id" value="{{ it.id }}">
                        <input type="hidden" name="action" value="add_collection">
                        <input type="hidden" name="return" value="{{ return_to }}">
                        <button type="submit" class="btn-small" {{ it.in_collection or it.in_wantlist ? 'disabled' : '' }}>+ Collection</button>
                      </form>
                      <form method="post" action="/release/add">
                        <input type="hidden" name="_token" value="{{ csrf_token }}">
                        <input type="hidden" name="release_id" value="{{ it.id }}">
                        <input type="hidden" name="action" value="add_want">
                        <input type="hidden" name="return" value="{{ return_to }}">
                        <button type="submit" class="btn-small" {{ it.in_collection or it.in_wantlist ? 'disabled' : '' }}>+ Wantlist</button>
                      </form>
                    </div>
                    {% if it.in_collection %}
                      <div class="muted" style="font-size:.75rem;margin-top:4px">Already in Collection</div>
                    {% elseif it.in_wantlist %}
                      <div class="muted" style="font-size:.75rem;margin-top:4px">Already in Wantlist</div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>

          {% if total_pages is defined and total_pages > 1 %}
            <nav aria-label="Pagination" style="margin-top:28px">
              {% set base = '/?view=' ~ (view|default('collection')) ~ '&per_page=' ~ per_page ~ '&sort=' ~ sort ~ (q is defined and q ? '&q=' ~ (q|url_encode) : '') %}
              {% set hasPrev = page > 1 %}
              {% set hasNext = page < total_pages %}
              {% set prev = page - 1 %}
              {% set next = page + 1 %}

              <div class="pagination">
                <a class="page-btn {{ hasPrev ? '' : 'is-disabled' }}" href="{{ hasPrev ? (base ~ '&page=1') : '#' }}" aria-label="First page" aria-disabled="{{ hasPrev ? 'false' : 'true' }}">¬´</a>
                <a class="page-btn {{ hasPrev ? '' : 'is-disabled' }}" href="{{ hasPrev ? (base ~ '&page=' ~ prev) : '#' }}" aria-label="Previous page" aria-disabled="{{ hasPrev ? 'false' : 'true' }}">‚Äπ</a>

                {# Determine window around current page #}
                {% set window = 2 %}
                {% set start = (page - window) > 1 ? (page - window) : 1 %}
                {% set end = (page + window) < total_pages ? (page + window) : total_pages %}

                {# Leading ellipsis #}
                {% if start > 1 %}
                  <a class="page-btn" href="{{ base ~ '&page=1' }}">1</a>
                  {% if start > 2 %}
                    <span class="page-ellipsis">‚Ä¶</span>
                  {% endif %}
                {% endif %}

                {# Middle pages #}
                {% for p in range(start, end) %}
                  {% if p == page %}
                    <span class="page-btn page-num is-current" aria-current="page">{{ p }}</span>
                  {% else %}
                    <a class="page-btn page-num" href="{{ base ~ '&page=' ~ p }}">{{ p }}</a>
                  {% endif %}
                {% endfor %}

                {# Trailing ellipsis #}
                {% if end < total_pages %}
                  {% if end < (total_pages - 1) %}
                    <span class="page-ellipsis">‚Ä¶</span>
                  {% endif %}
                  <a class="page-btn" href="{{ base ~ '&page=' ~ total_pages }}">{{ total_pages }}</a>
                {% endif %}

                <a class="page-btn {{ hasNext ? '' : 'is-disabled' }}" href="{{ hasNext ? (base ~ '&page=' ~ next) : '#' }}" aria-label="Next page" aria-disabled="{{ hasNext ? 'false' : 'true' }}">‚Ä∫</a>
                <a class="page-btn {{ hasNext ? '' : 'is-disabled' }}" href="{{ hasNext ? (base ~ '&page=' ~ total_pages) : '#' }}" aria-label="Last page" aria-disabled="{{ hasNext ? 'false' : 'true' }}">¬ª</a>
              </div>

              <div class="muted" style="text-align:center;margin-top:8px;font-size:.9rem">Page {{ page }} of {{ total_pages }}</div>
            </nav>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // '/' to focus search
    document.addEventListener('keydown', function(e){
      if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
        const inp = document.getElementById('search-input');
        if (inp) { e.preventDefault(); inp.focus(); }
      }
    });
    // Skeleton loader for cover images
    const imgs = document.querySelectorAll('img.cover');
    imgs.forEach(img => {
      if (img.complete) img.classList.add('ready');
      else img.addEventListener('load', () => img.classList.add('ready'));
    });
    // Back to top
    const btn = document.getElementById('backToTop');
    if (btn) {
      window.addEventListener('scroll', () => {
        if (window.scrollY > 400) btn.style.display = 'block'; else btn.style.display = 'none';
      });
      btn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
    }

    function saveSearch() {
      const q = document.getElementById('search-input').value;
      const name = prompt('Name this Smart Collection:', '');
      if (name && name.trim() !== '') {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/saved-searches';
        
        const qInput = document.createElement('input');
        qInput.type = 'hidden';
        qInput.name = 'q';
        qInput.value = q;
        form.appendChild(qInput);
        
        const nameInput = document.createElement('input');
        nameInput.type = 'hidden';
        nameInput.name = 'name';
        nameInput.value = name;
        form.appendChild(nameInput);
        
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = '_token';
        tokenInput.value = '{{ csrf_token }}';
        form.appendChild(tokenInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
  <button id="backToTop" title="Back to top" style="position:fixed;right:16px;bottom:16px;display:none;background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:999px;padding:10px 12px;cursor:pointer">‚Üë Top</button>
{% endblock %}
