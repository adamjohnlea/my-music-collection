{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
  <style>
    header{z-index:10;margin:0 0 24px 0;padding:0}
    .header-bottom{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    h1{font-size:1.4rem;margin:0}
    .stats{font-size:.9rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px}
    .card{background:var(--card);border-radius:12px;overflow:hidden}
    .cover-wrap{aspect-ratio:1/1;width:100%;overflow:hidden;position:relative}
    .cover{width:100%;height:100%;object-fit:cover;background:linear-gradient(90deg,#1a1b1f 25%,#22242a 37%,#1a1b1f 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    .cover.ready{animation:none;background:#222}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .meta{padding:12px}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .artist{color:var(--muted);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    nav{display:flex;justify-content:center;gap:12px;margin-top:20px}
    /* Toolbar */
    .toolbar{display:flex;gap:8px;align-items:center;margin:0;flex-wrap:wrap;flex:1}
    .search-input{background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:10px;padding:8px 14px;width:100%;font-size:.95rem}
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px rgba(103,232,249,.2)}
    .sort-wrap{display:flex;gap:8px;align-items:center}
    .sort-select{background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:10px;padding:8px 12px;font-size:.9rem;cursor:pointer}
    .sort-select:focus{outline:none;border-color:var(--accent)}
    /* Modern pagination */
    .pagination{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}
    .page-btn{display:inline-flex;align-items:center;justify-content:center;min-width:40px;height:40px;padding:0 12px;border-radius:12px;border:1px solid #2a2b2f;background:var(--card);color:var(--text);text-decoration:none;font-weight:600}
    .page-btn:hover{background:#1d1f24;text-decoration:none}
    .page-btn.is-current{background:linear-gradient(135deg,#222631,#1a1d24);border-color:#3a3d44;box-shadow:0 0 0 1px rgba(103,232,249,.2) inset;color:#fff}
    .page-btn.is-disabled{opacity:.5;pointer-events:none}
    .page-ellipsis{color:var(--muted);padding:0 6px}

    /* Sidebar and Layout */
    .main-layout{display:grid;grid-template-columns:240px 1fr;gap:32px;align-items:start;transition:grid-template-columns .3s ease}
    .main-layout.collapsed{grid-template-columns:0 1fr;gap:0}
    .sidebar{position:sticky;top:100px;display:flex;flex-direction:column;gap:24px;overflow:hidden;transition:opacity .3s ease, transform .3s ease}
    .main-layout.collapsed .sidebar{opacity:0;pointer-events:none;transform:translateX(-20px)}
    .sidebar-section h3{font-size:.85rem;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin:0 0 12px 0;white-space:nowrap}
    .main-layout.collapsed .sidebar-section h3{display:none}
    .sidebar-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px}
    .sidebar-link{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:8px;font-size:.95rem;color:var(--text);text-decoration:none;transition:background .2s;white-space:nowrap}
    .sidebar-link:hover{background:rgba(255,255,255,.05);text-decoration:none}
    .sidebar-link.active{background:rgba(103,232,249,.1);color:var(--accent)}
    .sidebar-link .delete-btn{opacity:0;background:transparent;border:none;color:var(--muted);cursor:pointer;padding:4px;line-height:1}
    .sidebar-link:hover .delete-btn{opacity:1}
    .sidebar-link .delete-btn:hover{color:#ff4444}
    
    .sidebar-toggle-btn{background:var(--card);border:1px solid #2a2b2f;color:var(--muted);border-radius:8px;padding:6px;cursor:pointer;margin-bottom:16px;display:inline-flex;align-items:center;justify-content:center;transition:all .2s;width:36px;height:36px}
    .sidebar-toggle-btn:hover{color:var(--accent);border-color:var(--accent);background:rgba(255,255,255,.05)}
    .sidebar-toggle-btn svg{width:20px;height:20px;fill:currentColor}

    #qb-toggle.active { background: var(--accent); color: #000; border-color: var(--accent); }

    .mobile-chips{display:none;gap:8px;overflow-x:auto;padding-bottom:12px;margin-bottom:16px;scrollbar-width:none}
    .mobile-chips::-webkit-scrollbar{display:none}
    .chip{white-space:nowrap;background:var(--card);border:1px solid #2a2b2f;padding:6px 14px;border-radius:20px;font-size:.9rem;color:var(--text);text-decoration:none}
    .chip.active{background:rgba(103,232,249,.1);color:var(--accent);border-color:var(--accent)}

    /* Small screens */
    @media (max-width: 768px){
      .main-layout{grid-template-columns:1fr}
      .main-layout.collapsed{grid-template-columns:1fr}
      .sidebar{display:none}
      .sidebar-toggle-btn{display:none}
      .mobile-chips{display:flex}
      .wrap{margin:12px auto}
      header{margin-bottom:16px}
      .header-bottom{flex-direction:column;align-items:stretch;gap:12px}
      .toolbar{width:100%;flex-direction:column;align-items:stretch}
      .search-input{width:100%}
      .sort-wrap{width:100%}
      .sort-select{width:100%}
      
      /* Make pagination sticky at the bottom with safe-area */
      .pagination{position:sticky;bottom:calc(8px + env(safe-area-inset-bottom));background:rgba(11,11,12,.8);backdrop-filter:blur(8px);padding:8px 12px;border-radius:14px;border:1px solid #2a2b2f;z-index:80}
      .page-num,.page-ellipsis{display:none}
      .page-btn{min-width:64px;height:44px;font-size:1rem}
    }
  </style>
{% endblock %}

{% block header %}
  <div class="wrap">
    <header>
      {% if not welcome and not needs_setup %}
        <div class="header-bottom">
          <form id="search-form" class="toolbar" method="get" action="/">
            <div style="display:flex;gap:8px;width:100%">
              <input id="search-input" class="search-input" type="text" name="q" value="{{ q|default('')|e }}" placeholder="Search artist:miles year:1980..1989 barcode:‚Ä¶" />
              <button type="button" id="qb-toggle" class="btn-small" onclick="toggleQueryBuilder()" title="Toggle Search Builder" style="height:40px">Advanced</button>
              {% if q is defined and q %}
                <button type="button" class="btn-small" onclick="saveSearch()" title="Save as Smart Collection" style="height:40px">Save</button>
              {% endif %}
            </div>
            <input type="hidden" name="view" value="{{ view|default('collection') }}" />
            <input type="hidden" name="per_page" value="{{ per_page }}" />
            <div class="sort-wrap">
              <select id="sort" class="sort-select" name="sort" onchange="this.form.submit()">
                <optgroup label="Sort by">
                  <option value="added_desc" {{ sort=='added_desc'?'selected':'' }}>Added (newest)</option>
                  <option value="added_asc" {{ sort=='added_asc'?'selected':'' }}>Added (oldest)</option>
                  {% if view != 'wantlist' %}
                    <option value="rating_desc" {{ sort=='rating_desc'?'selected':'' }}>Rating (high‚Üílow)</option>
                    <option value="rating_asc" {{ sort=='rating_asc'?'selected':'' }}>Rating (low‚Üíhigh)</option>
                  {% endif %}
                  <option value="year_desc" {{ sort=='year_desc'?'selected':'' }}>Year (newest)</option>
                  <option value="year_asc" {{ sort=='year_asc'?'selected':'' }}>Year (oldest)</option>
                  <option value="artist_asc" {{ sort=='artist_asc'?'selected':'' }}>Artist (A‚ÜíZ)</option>
                  <option value="artist_desc" {{ sort=='artist_desc'?'selected':'' }}>Artist (Z‚ÜíA)</option>
                  <option value="title_asc" {{ sort=='title_asc'?'selected':'' }}>Title (A‚ÜíZ)</option>
                  <option value="title_desc" {{ sort=='title_desc'?'selected':'' }}>Title (Z‚ÜíA)</option>
                </optgroup>
              </select>
            </div>
          </form>
        </div>
      {% endif %}
    </header>
  </div>

  <div class="utility-bar" id="sticky-utility">
    <div style="display:flex;gap:8px">
        <input type="text" class="search-input" placeholder="Search..." onfocus="window.scrollTo(0,0); document.getElementById('search-input').focus();">
        <select class="sort-select" onchange="document.getElementById('sort').value = this.value; document.getElementById('search-form').submit();">
            <option value="">Sort...</option>
            <option value="added_desc">Added (newest)</option>
            <option value="year_desc">Year (newest)</option>
            <option value="artist_asc">Artist (A-Z)</option>
        </select>
    </div>
  </div>
{% endblock %}

{% block breadcrumbs %}
  <nav class="breadcrumbs">
    <div>
      <a href="/">Home</a>
      <span>/</span>
      {{ view|capitalize|default('Collection') }}
    </div>
    {% if total is defined %}
      <div class="muted" style="font-size: 0.85rem">
        {{ total|default(0) }} items
        {% if q is defined and q %} ‚Ä¢ Search: ‚Äú{{ q }}‚Äù{% endif %}
      </div>
    {% endif %}
  </nav>
{% endblock %}

{% block content %}
  <div class="wrap content-wrap">
    {% if error is defined or app.request.query.get('error') %}
      <div style="background:rgba(255, 68, 68, 0.1); border-left: 4px solid #ff4444; padding: 12px; margin-bottom: 16px;">
        <p style="margin:0; color:#ff4444; font-weight:bold;">Error</p>
        <p style="margin:8px 0 0 0; font-size: 0.9rem;">{{ error|default(app.request.query.get('error')) }}</p>
      </div>
    {% endif %}

    {% if not welcome and not needs_setup %}
      {% include 'partials/query_builder.html.twig' %}
      <div class="mobile-chips">
        <a href="/" class="chip {{ q == '' ? 'active' : '' }}">All Items</a>
        {% if saved_searches is defined %}
          {% for s in saved_searches %}
            <a href="/?q={{ s.query|url_encode }}" class="chip {{ q == s.query ? 'active' : '' }}">{{ s.name }}</a>
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}

    <div class="main-layout" id="main-layout">
      <aside class="sidebar">
        <div class="sidebar-section">
          <h3>Smart Collections</h3>
          <ul class="sidebar-list">
            <li>
              <a href="/" class="sidebar-link {{ q == '' ? 'active' : '' }}">
                <span class="link-text">All Items</span>
              </a>
            </li>
            {% if saved_searches is defined %}
              {% for s in saved_searches %}
                <li>
                  <a href="/?q={{ s.query|url_encode }}" class="sidebar-link {{ q == s.query ? 'active' : '' }}">
                    <span class="link-text">{{ s.name }}</span>
                    <form method="post" action="/saved-searches/delete" style="display:inline" class="delete-form">
                      <input type="hidden" name="_token" value="{{ csrf_token }}">
                      <input type="hidden" name="id" value="{{ s.id }}">
                      <button type="submit" class="delete-btn" title="Delete collection" onclick="return confirm('Delete this smart collection?')">√ó</button>
                    </form>
                  </a>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
      </aside>
      
      <div class="main-content">
        <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
          <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM5 7h5v10H5V7z"/></svg>
        </button>
        {% if welcome %}
          <div class="card"><div class="meta">
            <h2 style="margin:0 0 8px 0">Welcome</h2>
            <p class="muted">Browse your Discogs collection locally, fast.</p>
            <p>Learn more on the <a href="/about">About</a> page.</p>
          </div></div>
        {% elseif needs_setup %}
          <div class="card"><div class="meta">
            <h2 style="margin:0 0 8px 0">Connect your Discogs account</h2>
            {% if missing_credentials %}
              <div style="background:rgba(255, 68, 68, 0.1); border-left: 4px solid #ff4444; padding: 12px; margin-bottom: 16px;">
                <p style="margin:0; color:#ff4444; font-weight:bold;">Action Required: Discogs credentials missing</p>
                <p style="margin:8px 0 0 0; font-size: 0.9rem;">The default placeholders are still in your <code>.env</code> file. You must add your actual Discogs username and personal access token.</p>
                <p style="margin:8px 0 0 0; font-size: 0.85rem; color: var(--muted);">
                  <strong>How to get your token:</strong><br>
                  1. Log in to <a href="https://www.discogs.com/settings/developers" target="_blank" rel="noopener">Discogs Developer Settings</a>.<br>
                  2. Click <strong>"Generate new token"</strong>.<br>
                  3. Copy the token and paste it into your <code>.env</code> file as <code>DISCOGS_TOKEN</code>.
                </p>
              </div>
            {% endif %}
            <p class="muted">To show your collection here, add your Discogs username and user token to your <code>.env</code> file, then run the initial sync from the terminal.</p>
            <ol style="margin:0 0 0 20px;padding:0">
              <li>Add <code>DISCOGS_USERNAME</code> and <code>DISCOGS_TOKEN</code> to your <code>.env</code> file.</li>
              <li>From your project folder, run: <code>php bin/console sync:initial</code></li>
              <li>Come back here to browse your collection.</li>
            </ol>
          </div></div>
        {% elseif items is not defined or items|length == 0 %}
          <p class="muted">No items to display. If you already ran the sync, try refreshing. Otherwise run: <code>php bin/console sync:initial</code>.</p>
        {% else %}
          {% set return_to = '/?view=' ~ (view|default('collection')) ~ '&per_page=' ~ per_page ~ '&sort=' ~ sort ~ '&page=' ~ page ~ (q is defined and q ? '&q=' ~ (q|url_encode) : '') %}
          <div class="grid">
            {% for it in items %}
              <div class="card" title="{{ it.title }} ‚Äî {{ it.artist|strip_discogs_suffix }}">
                <div class="cover-wrap">
                  {% if it.image %}
                    <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">
                      <img class="cover" src="{{ it.image }}" alt="{{ it.title }} cover" loading="lazy" />
                    </a>
                  {% else %}
                    <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">
                      <div class="cover"></div>
                    </a>
                  {% endif %}
                </div>
                <div class="meta">
                  <div class="title">
                    {% if it.is_discogs_result %}
                      <span title="Discogs Result" style="cursor:help">üåê</span>
                    {% endif %}
                    <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">{{ it.title }}</a>
                  </div>
                  <div class="artist">
                    {% if it.is_discogs_result %}
                      {# artist name is often included in title for discogs search results #}
                    {% else %}
                      <a href="/?view={{ view|default('collection') }}&per_page={{ per_page }}&sort={{ sort }}&q={{ ('artist:\"' ~ it.artist ~ '\"')|url_encode }}">{{ it.artist|strip_discogs_suffix }}</a>
                    {% endif %}
                    {% if it.year %}
                      {% if not it.is_discogs_result %} ‚Ä¢ {% endif %}
                      <a href="/?view={{ view|default('collection') }}&per_page={{ per_page }}&sort={{ sort }}&q={{ ('year:' ~ it.year)|url_encode }}">{{ it.year }}</a>
                    {% endif %}
                  </div>
                  
                  {% if it.is_discogs_result %}
                    <div class="action-btns">
                      <form method="post" action="/release/add">
                        <input type="hidden" name="_token" value="{{ csrf_token }}">
                        <input type="hidden" name="release_id" value="{{ it.id }}">
                        <input type="hidden" name="action" value="add_collection">
                        <input type="hidden" name="return" value="{{ return_to }}">
                        <button type="submit" class="btn-small" {{ it.in_collection or it.in_wantlist ? 'disabled' : '' }}>+ Collection</button>
                      </form>
                      <form method="post" action="/release/add">
                        <input type="hidden" name="_token" value="{{ csrf_token }}">
                        <input type="hidden" name="release_id" value="{{ it.id }}">
                        <input type="hidden" name="action" value="add_want">
                        <input type="hidden" name="return" value="{{ return_to }}">
                        <button type="submit" class="btn-small" {{ it.in_collection or it.in_wantlist ? 'disabled' : '' }}>+ Wantlist</button>
                      </form>
                    </div>
                    {% if it.in_collection %}
                      <div class="muted" style="font-size:.75rem;margin-top:4px">Already in Collection</div>
                    {% elseif it.in_wantlist %}
                      <div class="muted" style="font-size:.75rem;margin-top:4px">Already in Wantlist</div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>

          {% if total_pages is defined and total_pages > 1 %}
            <nav aria-label="Pagination" style="margin-top:28px">
              {% set base = '/?view=' ~ (view|default('collection')) ~ '&per_page=' ~ per_page ~ '&sort=' ~ sort ~ (q is defined and q ? '&q=' ~ (q|url_encode) : '') %}
              {% set hasPrev = page > 1 %}
              {% set hasNext = page < total_pages %}
              {% set prev = page - 1 %}
              {% set next = page + 1 %}

              <div class="pagination">
                <a class="page-btn {{ hasPrev ? '' : 'is-disabled' }}" href="{{ hasPrev ? (base ~ '&page=1') : '#' }}" aria-label="First page" aria-disabled="{{ hasPrev ? 'false' : 'true' }}">¬´</a>
                <a class="page-btn {{ hasPrev ? '' : 'is-disabled' }}" href="{{ hasPrev ? (base ~ '&page=' ~ prev) : '#' }}" aria-label="Previous page" aria-disabled="{{ hasPrev ? 'false' : 'true' }}">‚Äπ</a>

                {# Determine window around current page #}
                {% set window = 2 %}
                {% set start = (page - window) > 1 ? (page - window) : 1 %}
                {% set end = (page + window) < total_pages ? (page + window) : total_pages %}

                {# Leading ellipsis #}
                {% if start > 1 %}
                  <a class="page-btn" href="{{ base ~ '&page=1' }}">1</a>
                  {% if start > 2 %}
                    <span class="page-ellipsis">‚Ä¶</span>
                  {% endif %}
                {% endif %}

                {# Middle pages #}
                {% for p in range(start, end) %}
                  {% if p == page %}
                    <span class="page-btn page-num is-current" aria-current="page">{{ p }}</span>
                  {% else %}
                    <a class="page-btn page-num" href="{{ base ~ '&page=' ~ p }}">{{ p }}</a>
                  {% endif %}
                {% endfor %}

                {# Trailing ellipsis #}
                {% if end < total_pages %}
                  {% if end < (total_pages - 1) %}
                    <span class="page-ellipsis">‚Ä¶</span>
                  {% endif %}
                  <a class="page-btn" href="{{ base ~ '&page=' ~ total_pages }}">{{ total_pages }}</a>
                {% endif %}

                <a class="page-btn {{ hasNext ? '' : 'is-disabled' }}" href="{{ hasNext ? (base ~ '&page=' ~ next) : '#' }}" aria-label="Next page" aria-disabled="{{ hasNext ? 'false' : 'true' }}">‚Ä∫</a>
                <a class="page-btn {{ hasNext ? '' : 'is-disabled' }}" href="{{ hasNext ? (base ~ '&page=' ~ total_pages) : '#' }}" aria-label="Last page" aria-disabled="{{ hasNext ? 'false' : 'true' }}">¬ª</a>
              </div>

              <div class="muted" style="text-align:center;margin-top:8px;font-size:.9rem">Page {{ page }} of {{ total_pages }}</div>
            </nav>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // '/' to focus search
    document.addEventListener('keydown', function(e){
      if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
        const inp = document.getElementById('search-input');
        if (inp) { e.preventDefault(); inp.focus(); }
      }
    });

    // Sticky utility bar visibility
    const utilityBar = document.getElementById('sticky-utility');
    const headerBottom = document.querySelector('.header-bottom');
    if (utilityBar && headerBottom) {
        window.addEventListener('scroll', () => {
            if (window.innerWidth <= 768) {
                const rect = headerBottom.getBoundingClientRect();
                if (rect.bottom < 65) {
                    utilityBar.classList.add('is-visible');
                } else {
                    utilityBar.classList.remove('is-visible');
                }
            } else {
                utilityBar.classList.remove('is-visible');
            }
        });
    }

    // Sidebar toggle
    function toggleSidebar() {
        const layout = document.getElementById('main-layout');
        layout.classList.toggle('collapsed');
        localStorage.setItem('sidebar-collapsed', layout.classList.contains('collapsed'));
    }
    // Restore sidebar state
    if (localStorage.getItem('sidebar-collapsed') === 'true') {
        document.getElementById('main-layout')?.classList.add('collapsed');
    }

    // Skeleton loader for cover images
    const imgs = document.querySelectorAll('img.cover');
    imgs.forEach(img => {
      if (img.complete) img.classList.add('ready');
      else img.addEventListener('load', () => img.classList.add('ready'));
    });
    // Back to top
    const btn = document.getElementById('backToTop');
    if (btn) {
      window.addEventListener('scroll', () => {
        if (window.scrollY > 400) btn.style.display = 'block'; else btn.style.display = 'none';
      });
      btn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
    }

    function saveSearch() {
      const q = document.getElementById('search-input').value;
      const name = prompt('Name this Smart Collection:', '');
      if (name && name.trim() !== '') {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/saved-searches';
        
        const qInput = document.createElement('input');
        qInput.type = 'hidden';
        qInput.name = 'q';
        qInput.value = q;
        form.appendChild(qInput);
        
        const nameInput = document.createElement('input');
        nameInput.type = 'hidden';
        nameInput.name = 'name';
        nameInput.value = name;
        form.appendChild(nameInput);
        
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = '_token';
        tokenInput.value = '{{ csrf_token }}';
        form.appendChild(tokenInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
  <button id="backToTop" title="Back to top" style="position:fixed;right:16px;bottom:16px;display:none;background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:999px;padding:10px 12px;cursor:pointer">‚Üë Top</button>
{% endblock %}
