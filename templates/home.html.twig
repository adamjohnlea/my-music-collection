{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
  <style>
    :root { --bg:#0b0b0c; --card:#16171a; --text:#e7e7ea; --muted:#a0a3aa; --accent:#67e8f9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    .wrap{max-width:1200px;margin:40px auto;padding:0 20px}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(11,11,12,.7);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin:-16px -20px 24px -20px;padding:16px 20px}
    h1{font-size:1.5rem;margin:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden}
    .cover{aspect-ratio:1/1;width:100%;object-fit:cover;background:linear-gradient(90deg,#1a1b1f 25%,#22242a 37%,#1a1b1f 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    .cover.ready{animation:none;background:#222}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .meta{padding:10px}
    .title{font-weight:600}
    .artist{color:var(--muted);font-size:.9rem}
    .muted{color:var(--muted)}
    nav{display:flex;justify-content:center;gap:12px;margin-top:20px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    /* Toolbar */
    .toolbar{display:flex;gap:8px;align-items:center;margin:0;flex-wrap:wrap}
    .search-input{background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:8px 12px;width:360px;max-width:100%}
    .sort-wrap{display:flex;gap:8px;align-items:center}
    .sort-select{background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:8px 8px}
    /* Modern pagination */
    .pagination{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}
    .page-btn{display:inline-flex;align-items:center;justify-content:center;min-width:40px;height:40px;padding:0 12px;border-radius:12px;border:1px solid #2a2b2f;background:var(--card);color:var(--text);text-decoration:none;font-weight:600}
    .page-btn:hover{background:#1d1f24;text-decoration:none}
    .page-btn.is-current{background:linear-gradient(135deg,#222631,#1a1d24);border-color:#3a3d44;box-shadow:0 0 0 1px rgba(103,232,249,.2) inset;color:#fff}
    .page-btn.is-disabled{opacity:.5;pointer-events:none}
    .page-ellipsis{color:var(--muted);padding:0 6px}

    /* Small screens */
    @media (max-width: 640px){
      .wrap{margin:20px auto}
      header{gap:12px}
      .muted.stats{width:100%;order:1}
      .toolbar{width:100%;order:2}
      .search-input{width:100%}
      .sort-wrap{width:100%;justify-content:flex-start;margin-top:4px}
      .about-link{order:3;margin-left:0}
      /* Make pagination sticky at the bottom with safe-area */
      .pagination{position:sticky;bottom:calc(8px + env(safe-area-inset-bottom));background:rgba(11,11,12,.8);backdrop-filter:blur(8px);padding:8px 12px;border-radius:14px;border:1px solid #2a2b2f}
      .page-num,.page-ellipsis{display:none}
      .page-btn{min-width:64px;height:44px;font-size:1rem}
    }
  </style>
{% endblock %}

{% block header %}
  <div class="wrap">
    <header>
      <h1><a href="/" style="color:inherit;text-decoration:none">{{ title }}</a></h1>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div class="muted stats">{{ total|default(0) }} items{% if q is defined and q %} • Search: “{{ q }}”{% endif %}</div>
        <form id="search-form" class="toolbar" method="get" action="/">
          <input id="search-input" class="search-input" type="text" name="q" value="{{ q|default('')|e }}" placeholder="Search artist:miles year:1980..1989 barcode:…" />
          <input type="hidden" name="page" value="{{ page }}" />
          <input type="hidden" name="per_page" value="{{ per_page }}" />
          <span class="sort-wrap">
            <label for="sort" class="muted" style="font-size:.9rem">Sort</label>
            <select id="sort" class="sort-select" name="sort" onchange="this.form.submit()">
              <optgroup label="Collection">
                <option value="added_desc" {{ sort=='added_desc'?'selected':'' }}>Added (newest)</option>
                <option value="added_asc" {{ sort=='added_asc'?'selected':'' }}>Added (oldest)</option>
                <option value="rating_desc" {{ sort=='rating_desc'?'selected':'' }}>Rating (high→low)</option>
                <option value="rating_asc" {{ sort=='rating_asc'?'selected':'' }}>Rating (low→high)</option>
              </optgroup>
              <optgroup label="Release">
                <option value="year_desc" {{ sort=='year_desc'?'selected':'' }}>Year (newest)</option>
                <option value="year_asc" {{ sort=='year_asc'?'selected':'' }}>Year (oldest)</option>
                <option value="artist_asc" {{ sort=='artist_asc'?'selected':'' }}>Artist (A→Z)</option>
                <option value="artist_desc" {{ sort=='artist_desc'?'selected':'' }}>Artist (Z→A)</option>
                <option value="title_asc" {{ sort=='title_asc'?'selected':'' }}>Title (A→Z)</option>
                <option value="title_desc" {{ sort=='title_desc'?'selected':'' }}>Title (Z→A)</option>
              </optgroup>
            </select>
          </span>
          <a href="/about" class="muted about-link" style="margin-left:8px">About</a>
        </form>
      </div>
      {% if chips is defined and chips %}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          {% for c in chips %}
            <span class="muted" style="border:1px solid #2a2b2f;border-radius:999px;padding:2px 10px">{{ c.label }}</span>
          {% endfor %}
          <a href="/?per_page={{ per_page }}&sort={{ sort }}" class="muted" style="margin-left:4px">Clear</a>
        </div>
      {% endif %}
    </header>
  </div>
{% endblock %}

{% block content %}
  <div class="wrap">
    {% if items is not defined or items|length == 0 %}
      <p class="muted">No items to display. If you already ran the sync, try refreshing. Otherwise run: <code>php bin/console sync:initial</code>.</p>
    {% else %}
      {% set return_to = '/?per_page=' ~ per_page ~ '&sort=' ~ sort ~ '&page=' ~ page ~ (q is defined and q ? '&q=' ~ (q|url_encode) : '') %}
      <div class="grid">
        {% for it in items %}
          <div class="card" title="{{ it.title }} — {{ it.artist|strip_discogs_suffix }}">
            {% if it.image %}
              <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">
                <img class="cover" src="{{ it.image }}" alt="{{ it.title }} cover" loading="lazy" />
              </a>
            {% else %}
              <a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">
                <div class="cover"></div>
              </a>
            {% endif %}
            <div class="meta">
              <div class="title"><a href="/release/{{ it.id }}?return={{ return_to|url_encode }}">{{ it.title }}</a></div>
              <div class="artist">
                <a href="/?per_page={{ per_page }}&sort={{ sort }}&q={{ ('artist:\"' ~ it.artist ~ '\"')|url_encode }}">{{ it.artist|strip_discogs_suffix }}</a>
                {% if it.year %}
                  • <a href="/?per_page={{ per_page }}&sort={{ sort }}&q={{ ('year:' ~ it.year)|url_encode }}">{{ it.year }}</a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if total_pages is defined and total_pages > 1 %}
        <nav aria-label="Pagination" style="margin-top:28px">
          {% set base = '/?per_page=' ~ per_page ~ '&sort=' ~ sort ~ (q is defined and q ? '&q=' ~ (q|url_encode) : '') %}
          {% set hasPrev = page > 1 %}
          {% set hasNext = page < total_pages %}
          {% set prev = page - 1 %}
          {% set next = page + 1 %}

          <div class="pagination">
            <a class="page-btn {{ hasPrev ? '' : 'is-disabled' }}" href="{{ hasPrev ? (base ~ '&page=1') : '#' }}" aria-label="First page" aria-disabled="{{ hasPrev ? 'false' : 'true' }}">«</a>
            <a class="page-btn {{ hasPrev ? '' : 'is-disabled' }}" href="{{ hasPrev ? (base ~ '&page=' ~ prev) : '#' }}" aria-label="Previous page" aria-disabled="{{ hasPrev ? 'false' : 'true' }}">‹</a>

            {# Determine window around current page #}
            {% set window = 2 %}
            {% set start = (page - window) > 1 ? (page - window) : 1 %}
            {% set end = (page + window) < total_pages ? (page + window) : total_pages %}

            {# Leading ellipsis #}
            {% if start > 1 %}
              <a class="page-btn" href="{{ base ~ '&page=1' }}">1</a>
              {% if start > 2 %}
                <span class="page-ellipsis">…</span>
              {% endif %}
            {% endif %}

            {# Middle pages #}
            {% for p in range(start, end) %}
              {% if p == page %}
                <span class="page-btn page-num is-current" aria-current="page">{{ p }}</span>
              {% else %}
                <a class="page-btn page-num" href="{{ base ~ '&page=' ~ p }}">{{ p }}</a>
              {% endif %}
            {% endfor %}

            {# Trailing ellipsis #}
            {% if end < total_pages %}
              {% if end < (total_pages - 1) %}
                <span class="page-ellipsis">…</span>
              {% endif %}
              <a class="page-btn" href="{{ base ~ '&page=' ~ total_pages }}">{{ total_pages }}</a>
            {% endif %}

            <a class="page-btn {{ hasNext ? '' : 'is-disabled' }}" href="{{ hasNext ? (base ~ '&page=' ~ next) : '#' }}" aria-label="Next page" aria-disabled="{{ hasNext ? 'false' : 'true' }}">›</a>
            <a class="page-btn {{ hasNext ? '' : 'is-disabled' }}" href="{{ hasNext ? (base ~ '&page=' ~ total_pages) : '#' }}" aria-label="Last page" aria-disabled="{{ hasNext ? 'false' : 'true' }}">»</a>
          </div>

          <div class="muted" style="text-align:center;margin-top:8px;font-size:.9rem">Page {{ page }} of {{ total_pages }}</div>
        </nav>
      {% endif %}
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  <script>
    // '/' to focus search
    document.addEventListener('keydown', function(e){
      if (e.key === '/' && !/input|textarea|select/i.test(document.activeElement.tagName)) {
        const inp = document.getElementById('search-input');
        if (inp) { e.preventDefault(); inp.focus(); }
      }
    });
    // Skeleton loader for cover images
    const imgs = document.querySelectorAll('img.cover');
    imgs.forEach(img => {
      if (img.complete) img.classList.add('ready');
      else img.addEventListener('load', () => img.classList.add('ready'));
    });
    // Back to top
    const btn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 400) btn.style.display = 'block'; else btn.style.display = 'none';
    });
    btn && btn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
  </script>
  <button id="backToTop" title="Back to top" style="position:fixed;right:16px;bottom:16px;display:none;background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:999px;padding:10px 12px;cursor:pointer">↑ Top</button>
{% endblock %}
