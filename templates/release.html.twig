{% extends 'base.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
  <style>
    :root { --overlay: rgba(0,0,0,.9); }
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:40px}
    .card{background:var(--card);border-radius:12px;overflow:hidden}
    .cover{width:100%;aspect-ratio:1/1;object-fit:cover;background:#222;cursor:zoom-in}
    .meta{padding:16px}
    h1{margin:0 0 8px 0;font-size:2rem}

    /* Carousel */
    .carousel-container { position: relative; width: 100%; overflow: hidden; border-radius: 12px; }
    .carousel-track { display: flex; transition: transform 0.3s ease-out; }
    .carousel-slide { min-width: 100%; aspect-ratio: 1/1; }
    .carousel-slide img { width: 100%; height: 100%; object-fit: cover; }
    .carousel-dots { display: none; justify-content: center; gap: 8px; margin-top: 12px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); cursor: pointer; opacity: 0.5; }
    .dot.active { background: var(--accent); opacity: 1; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid #2a2b2f; margin-top: 24px; overflow-x: auto; scrollbar-width: none; }
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 12px 20px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; white-space: nowrap; }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; padding-top: 20px; }
    .tab-content.active { display: block; }

    /* Lightbox */
    .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--overlay);z-index:1000}
    .lightbox.open{display:flex}
    .lb-inner{position:relative;max-width:95vw;max-height:95vh;display:flex;align-items:center;justify-content:center}
    .lb-img{max-width:95vw;max-height:95vh;object-fit:contain;box-shadow:0 10px 30px rgba(0,0,0,.6)}
    .lb-close{position:absolute;top:12px;right:12px;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:999px;width:40px;height:40px;cursor:pointer;font-size:20px}
    .lb-nav{position:absolute;top:50%;transform:translateY(-50%);display:flex;align-items:center;justify-content:center}
    .lb-prev,.lb-next{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:999px;width:44px;height:44px;cursor:pointer;font-size:20px}
    .lb-prev{left:-60px}
    .lb-next{right:-60px}
    .lb-counter{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);color:#fff;background:rgba(0,0,0,.5);padding:4px 10px;border-radius:999px;font-size:.9rem}

    @media (max-width: 800px){
      .layout{grid-template-columns:1fr; gap: 24px;}
      .carousel-dots { display: flex; }
      .lb-prev{left:10px}
      .lb-next{right:10px}
      .wrap { margin-top: 12px; }
    }
  </style>
{% endblock %}

{% block breadcrumbs %}
  <nav class="breadcrumbs">
    <div>
      <a href="/">Home</a>
      <span>/</span>
      <a href="/?view={{ details.in_wantlist ? 'wantlist' : 'collection' }}">{{ details.in_wantlist ? 'Wantlist' : 'Collection' }}</a>
      <span>/</span>
      {{ release.title }}
    </div>
  </nav>
{% endblock %}

{% block content %}
  <div class="wrap content-wrap">
    <div style="margin-bottom:24px">
      <p style="margin:0"><a href="{{ back_url|default('/') }}" style="background:var(--card);border:1px solid #2a2b2f;padding:6px 12px;border-radius:8px;color:var(--text);font-size:.9rem;text-decoration:none">← Back</a></p>
    </div>
    {% if release %}
      {% if saved %}
        <div id="flash-message" style="margin-bottom:24px; padding:12px 16px; border-radius:8px; background:{% if saved == 'queued' %}rgba(16,185,129,.1){% else %}rgba(239,68,68,.1){% endif %}; border:1px solid {% if saved == 'queued' %}#10b981{% else %}#ef4444{% endif %}; color:{% if saved == 'queued' %}#10b981{% else %}#ef4444{% endif %};">
          {% if saved == 'queued' %}
            Changes queued for Discogs sync.
          {% elseif saved == 'invalid_csrf' %}
            Invalid security token. Please try again.
          {% elseif saved == 'invalid_data' %}
            Invalid data submitted.
          {% elseif saved == 'no_instance' %}
            Release instance not found in your collection.
          {% else %}
            An error occurred while saving your changes.
          {% endif %}
        </div>
        <script>
          setTimeout(() => {
            const flash = document.getElementById('flash-message');
            if (flash) {
              flash.style.transition = 'opacity 0.5s ease-out';
              flash.style.opacity = '0';
              setTimeout(() => flash.remove(), 500);
            }
          }, 5000);
        </script>
      {% endif %}
      <div class="layout">
        <div>
          <div class="carousel-container" id="carousel">
            <div class="carousel-track" id="carousel-track">
              {% if images is defined and images|length > 0 %}
                {% for img in images %}
                  <div class="carousel-slide">
                    <img class="cover" src="{{ img.url }}" alt="{{ release.title }} cover" data-idx="{{ loop.index0 }}" />
                  </div>
                {% endfor %}
              {% elseif image_url %}
                 <div class="carousel-slide">
                    <img class="cover" src="{{ image_url }}" alt="{{ release.title }} cover" data-idx="0" />
                  </div>
              {% else %}
                <div class="carousel-slide">
                  <div class="cover"></div>
                </div>
              {% endif %}
            </div>
          </div>
          {% if images is defined and images|length > 1 %}
            <div class="carousel-dots" id="carousel-dots">
              {% for img in images %}
                <div class="dot {{ loop.first ? 'active' : '' }}" data-idx="{{ loop.index0 }}"></div>
              {% endfor %}
            </div>
            <div class="thumbs" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;">
              {% for img in images %}
                <button class="thumb" data-idx="{{ loop.index0 }}" style="border:0;background:transparent;padding:0;cursor:pointer">
                  <img src="{{ img.url }}" alt="thumb {{ loop.index }}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #2a2b2f;opacity:{% if img.is_primary %}1{% else %}.7{% endif %}" />
                </button>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div>
          <h1>{{ release.title }}</h1>
          <p class="muted" style="font-size:1.2rem">{{ release.artist|strip_discogs_suffix }}{% if release.year %} • {{ release.year }}{% endif %}</p>
          {% if release.country %}<p class="muted">{{ release.country }}</p>{% endif %}

          <div style="margin:16px 0; display:flex; gap:8px; flex-wrap:wrap">
            {% for g in details.genres %}<span class="muted" style="border:1px solid #2a2b2f;border-radius:12px;padding:4px 12px;font-size:.9rem">{{ g }}</span>{% endfor %}
            {% for s in details.styles %}<span class="muted" style="border:1px solid #2a2b2f;border-radius:12px;padding:4px 12px;font-size:.9rem">{{ s }}</span>{% endfor %}
          </div>

          {% if details.labels %}
            <p class="muted">Labels:
              {% for l in details.labels %}{{ l.name|strip_discogs_suffix }}{% if l.catno %} ({{ l.catno }}){% endif %}{% if not loop.last %}, {% endif %}{% endfor %}
            </p>
          {% endif %}

          <div class="tabs" id="release-tabs">
            <div class="tab active" data-tab="tracks">Tracks</div>
            <div class="tab" data-tab="details">Details</div>
            <div class="tab" data-tab="credits">Credits</div>
            <div class="tab" data-tab="status">Status & Notes</div>
          </div>

          <div id="tab-tracks" class="tab-content active">
            {% if details.tracklist %}
              <div class="card">
                <div class="meta">
                  <ol style="margin:0; padding-left:20px">
                    {% for t in details.tracklist %}
                      <li style="margin-bottom:8px">{{ t.position }} — {{ t.title }}{% if t.duration %} <span class="muted">({{ t.duration }})</span>{% endif %}</li>
                    {% endfor %}
                  </ol>
                </div>
              </div>
            {% else %}
               <p class="muted">No tracklist available.</p>
            {% endif %}
          </div>

          <div id="tab-details" class="tab-content">
            <div class="card">
                <div class="meta">
                    {% if details.formats %}
                        <p class="muted"><strong>Formats:</strong>
                        {% for f in details.formats %}
                            {{ f.name }}{% if f.text %} ({{ f.text }}){% endif %}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        </p>
                    {% endif %}
                    
                    {% if details.notes %}
                        <p><strong>Release Notes:</strong></p>
                        <div style="white-space:pre-wrap; font-size:.95rem" class="muted">{{ details.notes }}</div>
                    {% endif %}

                    {% if details.videos %}
                        <p><strong>Videos:</strong></p>
                        <ul style="margin:0; padding-left:20px">
                        {% for v in details.videos %}
                            <li><a href="{{ v.uri }}" target="_blank" rel="noopener">{{ v.title }}</a></li>
                        {% endfor %}
                        </ul>
                    {% endif %}

                    {% if details.barcodes %}
                        <p><strong>Barcodes:</strong></p>
                        <ul style="margin:0; padding-left:20px" class="muted">
                        {% for b in details.barcodes %}
                            <li>{{ b.value }}{% if b.description %} ({{ b.description }}){% endif %}</li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
          </div>

          <div id="tab-credits" class="tab-content">
             {% if details.extraartists or details.companies %}
                <div class="card">
                    <div class="meta">
                        {% if details.extraartists %}
                            <p><strong>Credits:</strong></p>
                            <ul style="margin:0; padding-left:20px" class="muted">
                            {% for a in details.extraartists %}
                                <li style="margin-bottom:4px">
                                {{ a.name|strip_discogs_suffix }}
                                {% if a.role %} — {{ a.role }}{% endif %}
                                {% if a.tracks %} (tracks: {{ a.tracks }}){% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        {% endif %}

                        {% if details.companies %}
                            <p style="margin-top:16px"><strong>Companies:</strong></p>
                            <ul style="margin:0; padding-left:20px" class="muted">
                            {% for c in details.companies %}
                                <li style="margin-bottom:4px">
                                {{ c.name|strip_discogs_suffix }}
                                {% if c.entity_type_name %} — {{ c.entity_type_name }}{% endif %}
                                {% if c.role %} ({{ c.role }}){% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
             {% else %}
                <p class="muted">No credit information available.</p>
             {% endif %}
          </div>

          <div id="tab-status" class="tab-content">
            <div class="card">
                <div class="meta">
                    <div style="margin-bottom:16px">
                        <strong>Discogs Status</strong>
                        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                            {% if details.in_collection %}
                            <span class="muted" style="border:1px solid #2a2b2f;border-radius:8px;padding:4px 10px;background:rgba(103,232,249,.1)">In Collection</span>
                            {% else %}
                            <form method="post" action="/release/save" style="margin:0">
                                <input type="hidden" name="_token" value="{{ csrf_token }}" />
                                <input type="hidden" name="release_id" value="{{ release.id }}" />
                                <input type="hidden" name="action" value="want_to_collection" />
                                <input type="hidden" name="return" value="{{ back_url|default('/') }}" />
                                <button type="submit" style="background:var(--card);color:var(--accent);border:1px solid #2a2b2f;border-radius:8px;padding:6px 10px;cursor:pointer">Add to Collection</button>
                            </form>
                            {% endif %}

                            {% if details.in_wantlist %}
                            <span class="muted" style="border:1px solid #2a2b2f;border-radius:8px;padding:4px 10px;background:rgba(255,255,255,.05)">In Wantlist</span>
                            <form method="post" action="/release/save" style="margin:0">
                                <input type="hidden" name="_token" value="{{ csrf_token }}" />
                                <input type="hidden" name="release_id" value="{{ release.id }}" />
                                <input type="hidden" name="action" value="remove_want" />
                                <input type="hidden" name="return" value="{{ back_url|default('/') }}" />
                                <button type="submit" class="muted" style="background:transparent;border:1px solid #2a2b2f;border-radius:8px;padding:6px 10px;cursor:pointer;color:inherit">Remove from Wantlist</button>
                            </form>
                            {% elseif not details.in_collection %}
                            <form method="post" action="/release/save" style="margin:0">
                                <input type="hidden" name="_token" value="{{ csrf_token }}" />
                                <input type="hidden" name="release_id" value="{{ release.id }}" />
                                <input type="hidden" name="action" value="add_want" />
                                <input type="hidden" name="return" value="{{ back_url|default('/') }}" />
                                <button type="submit" class="muted" style="background:transparent;border:1px solid #2a2b2f;border-radius:8px;padding:6px 10px;cursor:pointer;color:inherit">Add to Wantlist</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>

                    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                        <strong>My Notes</strong>
                        {% if not static_export and details.in_collection %}
                        <button id="editToggle" type="button" title="Edit" style="background:transparent;color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:.9rem">Edit</button>
                        {% endif %}
                    </div>

                    <div id="notesView" style="margin-top:8px">
                        {% if details.user_rating is not null %}
                        <div class="muted" style="margin-bottom:6px">Rating: {{ details.user_rating }}/5</div>
                        {% endif %}
                        {% if details.user_media_condition %}
                        <div class="muted" style="margin-bottom:6px">Media Condition: {{ details.user_media_condition }}</div>
                        {% endif %}
                        {% if details.user_sleeve_condition %}
                        <div class="muted" style="margin-bottom:6px">Sleeve Condition: {{ details.user_sleeve_condition }}</div>
                        {% endif %}
                        {% if details.user_notes %}
                        <div style="white-space:pre-wrap; font-size:.95rem" class="muted">{{ details.user_notes }}</div>
                        {% elseif details.in_collection %}
                        <div class="muted">(none)</div>
                        {% endif %}
                    </div>
                    {# (form remains similar but inside the tab) #}
                     {% if not static_export and details.in_collection %}
                        <form id="notesForm" method="post" action="/release/save" style="display:none; margin-top:8px; flex-direction:column; gap:12px">
                        <input type="hidden" name="_token" value="{{ csrf_token }}" />
                        <input type="hidden" name="release_id" value="{{ release.id }}" />
                        <input type="hidden" name="action" value="update_collection" />
                        <input type="hidden" name="return" value="{{ back_url|default('/') }}" />
                        <label>Rating
                            <select name="rating" style="width:100%; background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:8px">
                            <option value="">—</option>
                            {% for r in [0,1,2,3,4,5] %}
                                <option value="{{ r }}" {% if details.user_rating is not null and details.user_rating == r %}selected{% endif %}>{{ r }}/5</option>
                            {% endfor %}
                            </select>
                        </label>
                        <label>Media Condition
                            <select name="media_condition" style="width:100%; background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:8px">
                            <option value="">—</option>
                            {% for opt in ['Mint (M)', 'Near Mint (NM or M-)', 'Very Good Plus (VG+)', 'Very Good (VG)', 'Good Plus (G+)', 'Good (G)', 'Fair (F)', 'Poor (P)'] %}
                                <option value="{{ opt }}" {% if details.user_media_condition == opt %}selected{% endif %}>{{ opt }}</option>
                            {% endfor %}
                            </select>
                        </label>
                        <label>Sleeve Condition
                            <select name="sleeve_condition" style="width:100%; background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:8px">
                            <option value="">—</option>
                            {% for opt in ['Mint (M)', 'Near Mint (NM or M-)', 'Very Good Plus (VG+)', 'Very Good (VG)', 'Good Plus (G+)', 'Good (G)', 'Fair (F)', 'Poor (P)', 'Generic', 'No Cover'] %}
                                <option value="{{ opt }}" {% if details.user_sleeve_condition == opt %}selected{% endif %}>{{ opt }}</option>
                            {% endfor %}
                            </select>
                        </label>
                        <label>Notes
                            <textarea name="notes" rows="4" style="width:100%;background:var(--card);color:var(--text);border:1px solid #2a2b2f;border-radius:8px;padding:8px">{{ details.user_notes }}</textarea>
                        </label>
                        <div>
                            <button type="submit" style="background:var(--accent);color:#000;border:0;border-radius:8px;padding:10px 20px;cursor:pointer;font-weight:bold">Save Changes</button>
                        </div>
                        </form>
                    {% endif %}
                </div>
            </div>
          </div>
        </div>
      </div>

      {% if images is defined and images|length > 0 %}
      <!-- Lightbox overlay -->
      <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog">
        <div class="lb-inner">
          <button class="lb-close" aria-label="Close">✕</button>
          <button class="lb-prev" aria-label="Previous">◀</button>
          <img class="lb-img" src="" alt="Full-size image" />
          <button class="lb-next" aria-label="Next">▶</button>
          <div class="lb-counter">1 / {{ images|length }}</div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function(){
          const images = [
            {% for img in images %}'{{ img.url|e('js') }}'{% if not loop.last %}, {% endif %}{% endfor %}
          ];
          const track = document.getElementById('carousel-track');
          const dots = document.querySelectorAll('.dot');
          const thumbs = document.querySelectorAll('.thumb');
          const lb = document.getElementById('lightbox');
          const lbImg = lb ? lb.querySelector('.lb-img') : null;
          const lbClose = lb ? lb.querySelector('.lb-close') : null;
          const lbPrev = lb ? lb.querySelector('.lb-prev') : null;
          const lbNext = lb ? lb.querySelector('.lb-next') : null;
          const lbCounter = lb ? lb.querySelector('.lb-counter') : null;
          let idx = 0;

          function updateCarousel(to){
            idx = Math.max(0, Math.min(images.length - 1, to));
            if (track) track.style.transform = `translateX(-${idx * 100}%)`;
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
          }

          function openLightbox(startIdx){
            if (!lb || !lbImg) return;
            idx = Math.max(0, Math.min(images.length - 1, startIdx));
            lbImg.src = images[idx];
            if (lbCounter) lbCounter.textContent = (idx + 1) + ' / ' + images.length;
            lb.classList.add('open');
            lb.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
          }
          function closeLightbox(){
            if (!lb) return;
            lb.classList.remove('open');
            lb.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
          }
          function next(){ idx = (idx + 1) % images.length; if (lb.classList.contains('open')) { lbImg.src = images[idx]; lbCounter.textContent = (idx + 1) + ' / ' + images.length; } else { updateCarousel(idx); } }
          function prev(){ idx = (idx - 1 + images.length) % images.length; if (lb.classList.contains('open')) { lbImg.src = images[idx]; lbCounter.textContent = (idx + 1) + ' / ' + images.length; } else { updateCarousel(idx); } }

          // Carousel dot/thumb clicks
          dots.forEach(d => d.addEventListener('click', () => updateCarousel(parseInt(d.dataset.idx))));
          thumbs.forEach(t => t.addEventListener('click', () => updateCarousel(parseInt(t.dataset.idx))));

          // Lightbox trigger on carousel image click
          document.querySelectorAll('.carousel-slide img').forEach(img => {
            img.addEventListener('click', () => openLightbox(parseInt(img.dataset.idx)));
          });

          // Lightbox interactions
          lbClose?.addEventListener('click', closeLightbox);
          lbPrev?.addEventListener('click', prev);
          lbNext?.addEventListener('click', next);
          lbImg?.addEventListener('click', next);
          lb?.addEventListener('click', function(e){ if (e.target === lb) closeLightbox(); });

          // Keyboard
          document.addEventListener('keydown', function(e){
            if (!lb || !lb.classList.contains('open')) return;
            if (e.key === 'Escape') closeLightbox();
            else if (e.key === 'ArrowRight') next();
            else if (e.key === 'ArrowLeft') prev();
          });

          // Tabs
          const tabs = document.querySelectorAll('.tab');
          const contents = document.querySelectorAll('.tab-content');
          tabs.forEach(t => {
            t.addEventListener('click', () => {
              const target = t.dataset.tab;
              tabs.forEach(t2 => t2.classList.toggle('active', t2 === t));
              contents.forEach(c => c.classList.toggle('active', c.id === `tab-${target}`));
            });
          });

          // Handle tab parameter in URL
          const urlParams = new URLSearchParams(window.location.search);
          const activeTab = urlParams.get('tab');
          if (activeTab) {
            const tabEl = document.querySelector(`.tab[data-tab="${activeTab}"]`);
            if (tabEl) tabEl.click();
          }

          // Swipe support for carousel (basic)
          let startX = 0;
          track?.addEventListener('touchstart', e => startX = e.touches[0].clientX);
          track?.addEventListener('touchend', e => {
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
              if (diff > 0) next(); else prev();
            }
          });

          // Notes Toggle
          (function(){
            const btn = document.getElementById('editToggle');
            const form = document.getElementById('notesForm');
            const view = document.getElementById('notesView');
            if (!btn || !form || !view) return;
            btn.addEventListener('click', function(){
                const open = form.style.display === 'none';
                form.style.display = open ? 'flex' : 'none';
                view.style.display = open ? 'none' : 'block';
                btn.textContent = open ? 'Cancel' : 'Edit';
                if (open) {
                    // Switch to status tab if not active
                    document.querySelector('.tab[data-tab="status"]').click();
                }
            });
          })();
        });
      </script>
      {% endif %}
    {% else %}
      <p class="muted">Release not found.</p>
    {% endif %}
  </div>
{% endblock %}
