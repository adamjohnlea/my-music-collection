{% extends 'base.html.twig' %}

{% block title %}{{ title|default('Tools') }}{% endblock %}

{% block styles %}
  <style>
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden}
    .meta{padding:16px}
    form{display:grid;gap:10px;margin-top:8px}
    label{font-weight:600}
    input[type="text"],input[type="number"],input[type="password"],select{padding:10px 12px;border:1px solid #2a2b2f;border-radius:8px;background:#101114;color:var(--text);width:100%;box-sizing:border-box}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 200px}
    .actions{display:flex;gap:8px;align-items:center}
    button{background:#1f2937;border:1px solid #2a2b2f;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:hover{background:#232f41}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .ok{background:#0c3b21;border:1px solid #1e6b3a;color:#d6ffe6;padding:10px;border-radius:8px}
    .err{background:#3b0a0a;border:1px solid #742a2a;color:#ffd2d2;padding:10px;border-radius:8px}
    .help{color:var(--muted);font-size:.9rem}
    .spinner{display:none;gap:8px;align-items:center}
    .spinner.show{display:inline-flex}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:b 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
  </style>
{% endblock %}

{% block content %}
  <div class="wrap">
    <div id="progress-container" style="display:none;margin-bottom:16px">
      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 8px 0">Running Command</h2>
          <div style="margin-bottom:12px">
            <div class="spinner show" style="justify-content:flex-start">
              <span class="dot"></span><span class="dot"></span><span class="dot"></span>
              <span style="margin-left:8px" id="status-text">Starting...</span>
            </div>
          </div>
          <div style="background:#101114;border:1px solid #2a2b2f;border-radius:8px;padding:12px;max-height:400px;overflow-y:auto;font-family:ui-monospace,monospace;font-size:0.85rem;line-height:1.4">
            <pre id="output" style="margin:0;white-space:pre-wrap;word-wrap:break-word"></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Initial Sync</h2>
          <p class="help">Imports your entire Discogs collection into the local database. Run this once to get started.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="initial">
            <label class="row">
              <span class="help" style="flex:1 1 auto"><input type="checkbox" name="force"> Force (override safety check if DB already has data)</span>
            </label>
            <div class="actions">
              <button type="submit">Run initial sync</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Refresh</h2>
          <p class="help">Scans for newly added/changed items since the last run. Safe to run anytime.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="refresh">
            <div class="row">
              <label>Pages to scan
                <input type="number" name="pages" value="5" min="1" max="50">
              </label>
            </div>
            <div class="actions">
              <button type="submit">Run refresh</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Enrich</h2>
          <p class="help">Fetch full release details (tracklist, credits, companies, identifiers, notes, videos). Either target a specific release ID or process items missing details.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="enrich">
            <div class="row">
              <label>Release ID (optional)
                <input type="number" name="release_id" placeholder="123456">
              </label>
              <label>Limit (when no ID)
                <input type="number" name="limit" value="100" min="1" max="1000">
              </label>
            </div>
            <div class="actions">
              <button type="submit">Run enrich</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Backfill Images</h2>
          <p class="help">Downloads missing cover images to your local cache. For reliability, web runs fetch up to ~60 images per request (~1 req/sec, 1000/day cap). You can re-run safely to continue.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="images">
            <div class="row">
              <label>Limit
                <input type="number" name="limit" value="60" min="1" max="2000">
              </label>
            </div>
            <div class="actions">
              <button type="submit">Run backfill</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Rebuild Search Index</h2>
          <p class="help">Repairs or rebuilds the fullâ€‘text search index if results seem off. Safe to run anytime.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="search">
            <div class="actions">
              <button type="submit">Rebuild index</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Push Changes to Discogs</h2>
          <p class="help">Pushes queued changes (ratings, conditions, notes) back to Discogs. Processes items in the push_queue table.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="push">
            <div class="actions">
              <button type="submit">Push to Discogs</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Export Static Site</h2>
          <p class="help">Generates a static HTML site with JSON data files for offline hosting. Images can optionally be copied.</p>
          <form method="post" action="/tools/run">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="export">
            <div class="row">
              <label>Output Directory
                <input type="text" name="out" value="dist" placeholder="dist">
              </label>
              <label>Base URL
                <input type="text" name="base_url" value="/" placeholder="/">
              </label>
            </div>
            <div class="row">
              <label>Chunk Size (0=none)
                <input type="number" name="chunk_size" value="0" min="0" max="5000">
              </label>
              <label class="row" style="align-items:center">
                <span class="help" style="flex:1 1 auto"><input type="checkbox" name="copy_images"> Copy cached images</span>
              </label>
            </div>
            <div class="actions">
              <button type="submit">Export static site</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  let pollInterval = null;
  let currentJobId = null;

  function submitCommand(form, event) {
    event.preventDefault();

    // Show progress container
    const progressContainer = document.getElementById('progress-container');
    const outputEl = document.getElementById('output');
    const statusText = document.getElementById('status-text');

    progressContainer.style.display = 'block';
    outputEl.textContent = '';
    statusText.textContent = 'Starting command...';

    // Disable all form buttons
    document.querySelectorAll('form button').forEach(btn => btn.disabled = true);

    // Get form data
    const formData = new FormData(form);

    // Submit via AJAX
    fetch('/tools/run', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        outputEl.textContent = 'Error: ' + data.error;
        statusText.textContent = 'Error';
        enableAllButtons();
        return;
      }

      currentJobId = data.job_id;
      statusText.textContent = 'Running...';

      // Start polling for progress
      startPolling(currentJobId);
    })
    .catch(error => {
      outputEl.textContent = 'Failed to start command: ' + error;
      statusText.textContent = 'Error';
      enableAllButtons();
    });

    return false;
  }

  function startPolling(jobId) {
    if (pollInterval) {
      clearInterval(pollInterval);
    }

    pollInterval = setInterval(() => {
      fetch('/tools/progress/' + jobId)
        .then(response => response.json())
        .then(data => {
          updateProgress(data);

          if (data.status === 'completed' || data.status === 'error') {
            clearInterval(pollInterval);
            pollInterval = null;
            enableAllButtons();
          }
        })
        .catch(error => {
          console.error('Polling error:', error);
        });
    }, 500); // Poll every 500ms
  }

  function updateProgress(data) {
    const outputEl = document.getElementById('output');
    const statusText = document.getElementById('status-text');
    const spinner = document.querySelector('#progress-container .spinner');

    if (data.output && data.output.length > 0) {
      outputEl.textContent = data.output.join('\n');
      // Auto-scroll to bottom
      outputEl.parentElement.scrollTop = outputEl.parentElement.scrollHeight;
    }

    if (data.status === 'running') {
      statusText.textContent = 'Running... (' + (data.output ? data.output.length : 0) + ' lines)';
    } else if (data.status === 'completed') {
      statusText.textContent = 'Completed successfully!';
      statusText.style.color = 'var(--accent)';
      spinner.classList.remove('show');
    } else if (data.status === 'error') {
      statusText.textContent = 'Command failed (exit code: ' + (data.exit_code || 'unknown') + ')';
      statusText.style.color = '#ff6b6b';
      spinner.classList.remove('show');
    }
  }

  function enableAllButtons() {
    document.querySelectorAll('form button').forEach(btn => btn.disabled = false);
  }

  // Update all forms to use AJAX submission
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('form[action="/tools/run"]').forEach(form => {
      form.onsubmit = function(event) {
        return submitCommand(form, event);
      };
    });
  });
</script>
{% endblock %}
