{% extends 'base.html.twig' %}

{% block title %}{{ title|default('Tools') }}{% endblock %}

{% block styles %}
  <style>
    :root { --bg:#0b0b0c; --card:#16171a; --text:#e7e7ea; --muted:#a0a3aa; --accent:#67e8f9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    .wrap{max-width:860px;margin:40px auto;padding:0 20px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(11,11,12,.7);display:flex;align-items:center;justify-content:space-between;gap:10px;margin:-16px -20px 24px -20px;padding:16px 20px}
    h1{font-size:1.5rem;margin:0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:var(--card);border-radius:12px;overflow:hidden}
    .meta{padding:16px}
    .muted{color:var(--muted)}
    form{display:grid;gap:10px;margin-top:8px}
    label{font-weight:600}
    input[type="text"],input[type="number"],input[type="password"],select{padding:10px 12px;border:1px solid #2a2b2f;border-radius:8px;background:#101114;color:var(--text);width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 200px}
    .actions{display:flex;gap:8px;align-items:center}
    button{background:#1f2937;border:1px solid #2a2b2f;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:hover{background:#232f41}
    .ok{background:#0c3b21;border:1px solid #1e6b3a;color:#d6ffe6;padding:10px;border-radius:8px}
    .err{background:#3b0a0a;border:1px solid #742a2a;color:#ffd2d2;padding:10px;border-radius:8px}
    .help{color:var(--muted);font-size:.9rem}
    .spinner{display:none;gap:8px;align-items:center}
    .spinner.show{display:inline-flex}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:b 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
  </style>
{% endblock %}

{% block header %}
  <div class="wrap">
    <header>
      <h1><a href="/" style="color:inherit;text-decoration:none">Tools</a></h1>
      <nav style="display:flex;gap:10px;align-items:center">
        <a href="/about" class="muted">About</a>
        {% if auth_user %}
          <span class="muted">{{ auth_user.username }}</span>
          <a href="/settings">Settings</a>
          <form method="post" action="/logout" style="margin:0">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <button type="submit" class="muted" style="background:transparent;border:1px solid #2a2b2f;border-radius:8px;padding:6px 10px;cursor:pointer;color:inherit">Sign out</button>
          </form>
        {% else %}
          <a href="/register">Register</a>
          <a href="/login">Sign in</a>
        {% endif %}
      </nav>
    </header>
  </div>
{% endblock %}

{% block content %}
  <div class="wrap">
    {% if results %}
      <div class="card" style="margin-bottom:16px"><div class="meta">
        <h2 style="margin:0 0 8px 0">Results — {{ results.task|capitalize }}</h2>
        {% if results.ok %}
          <div class="ok">{{ results.messages|join(' ') }}</div>
        {% else %}
          <div class="err">{{ results.messages|join(' ') }}</div>
        {% endif %}
        {% if results.stats %}
          <pre class="muted" style="white-space:pre-wrap;margin:8px 0 0 0">{{ results.stats|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
        {% endif %}
        {% if results.next %}<p class="help" style="margin:8px 0 0 0">Next: {{ results.next }}</p>{% endif %}
      </div></div>
    {% endif %}

    <div class="grid">
      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Initial Sync</h2>
          <p class="help">Imports your entire Discogs collection into the local database. Run this once to get started.</p>
          <form method="post" action="/tools/run" onsubmit="return startSpin(this)">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="initial">
            <label class="row">
              <span class="help" style="flex:1 1 auto"><input type="checkbox" name="force"> Force (override safety check if DB already has data)</span>
            </label>
            <div class="actions">
              <button type="submit">Run initial sync</button>
              <span class="spinner" aria-live="polite"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Working…</span>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Refresh</h2>
          <p class="help">Scans for newly added/changed items since the last run. Safe to run anytime.</p>
          <form method="post" action="/tools/run" onsubmit="return startSpin(this)">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="refresh">
            <div class="row">
              <label>Pages to scan
                <input type="number" name="pages" value="5" min="1" max="50">
              </label>
            </div>
            <div class="actions">
              <button type="submit">Run refresh</button>
              <span class="spinner" aria-live="polite"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Working…</span>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Enrich</h2>
          <p class="help">Fetch full release details (tracklist, credits, companies, identifiers, notes, videos). Either target a specific release ID or process items missing details.</p>
          <form method="post" action="/tools/run" onsubmit="return startSpin(this)">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="enrich">
            <div class="row">
              <label>Release ID (optional)
                <input type="number" name="release_id" placeholder="123456">
              </label>
              <label>Limit (when no ID)
                <input type="number" name="limit" value="100" min="1" max="1000">
              </label>
            </div>
            <div class="actions">
              <button type="submit">Run enrich</button>
              <span class="spinner" aria-live="polite"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Working…</span>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Backfill Images</h2>
          <p class="help">Downloads missing cover images to your local cache. For reliability, web runs fetch up to ~60 images per request (~1 req/sec, 1000/day cap). You can re-run safely to continue.</p>
          <form method="post" action="/tools/run" onsubmit="return startSpin(this)">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="images">
            <div class="row">
              <label>Limit
                <input type="number" name="limit" value="60" min="1" max="2000">
              </label>
            </div>
            <div class="actions">
              <button type="submit">Run backfill</button>
              <span class="spinner" aria-live="polite"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Working…</span>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="meta">
          <h2 style="margin:0 0 6px 0">Rebuild Search Index</h2>
          <p class="help">Repairs or rebuilds the full‑text search index if results seem off. Safe to run anytime.</p>
          <form method="post" action="/tools/run" onsubmit="return startSpin(this)">
            <input type="hidden" name="_token" value="{{ csrf_token }}">
            <input type="hidden" name="task" value="search">
            <div class="actions">
              <button type="submit">Rebuild index</button>
              <span class="spinner" aria-live="polite"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Working…</span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  function startSpin(form){
    var s=form.querySelector('.spinner'); if(s){ s.classList.add('show'); }
    return true;
  }
</script>
{% endblock %}
